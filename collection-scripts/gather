#!/bin/bash
BASE_COLLECTION_PATH="/must-gather"

# generate /must-gather/version file
. version
echo "openshift/must-gather" > /must-gather/version
version >> /must-gather/version

# Resource List
resources=()

# Cluster Version Information 
resources+=(clusterversion ns/openshift-cluster-version)

# Operator Resources
resources+=(clusteroperators)

# Certificate Resources
resources+=(certificatesigningrequests)

# Machine/Node Resources
resources+=(nodes machineconfigs machineconfigpools)

# Namespaces/Project Resources
resources+=(ns/default ns/openshift ns/kube-system ns/openshift-etcd)

# Storage Resources
resources+=(storageclasses persistentvolumes volumeattachments)

# Image-source Resources
resources+=(imagecontentsourcepolicies.operator.openshift.io)

# Networking Resources
resources+=(networks.operator.openshift.io)

LOG_DIR="${BASE_COLLECTION_PATH}/must-gather-resource-logs"
mkdir -p ${LOG_DIR}

PIDS=()
# Run the Collection of Resources using must-gather
for resource in ${resources[@]}; do
    oc adm inspect ${resource} 2> ${LOG_DIR}/${resource/\//_}.log &
    PIDS+=($!)
done

# Collect System Audit Logs
/usr/bin/gather_audit_logs &
PIDS+=($!)

# Gather Service Logs (using a suplamental Script); Scoped to Masters.
/usr/bin/gather_service_logs master &
PIDS+=($!)
wait ${PIDS[@]}   ### Wait on all threads to complte.

exit 0     #### We always want our script to exit 0 to ensure some data collection.
